name: Build VCV Rack Plugin

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  rack-sdk-version: 2.6.1

defaults:
  run:
    shell: bash

jobs:
  build:
    name: ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: win-x64
            os: windows-latest
            arch-flags: ""
            install-dependencies: |
              choco install zip
          - platform: mac-x64
            os: macos-15
            arch-flags: -target x86_64-apple-macos10.9
            install-dependencies: |
              brew install zstd
          - platform: mac-arm64
            os: macos-latest
            arch-flags: ""
            install-dependencies: |
              brew install zstd
          - platform: lin-x64
            os: ubuntu-latest
            arch-flags: ""
            install-dependencies: |
              sudo apt-get update
              sudo apt-get install -y libgl1-mesa-dev zstd

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: ${{ matrix.install-dependencies }}

      - name: Download Rack SDK
        run: |
          curl -L https://vcvrack.com/downloads/Rack-SDK-${{ env.rack-sdk-version }}-${{ matrix.platform }}.zip -o rack-sdk.zip
          unzip -q rack-sdk.zip

      - name: Build plugin
        run: |
          export RACK_DIR=$PWD/Rack-SDK
          # For cross-compilation, patch SDK to use correct arch flags
          if [ "${{ matrix.platform }}" = "mac-x64" ]; then
            sed -i.bak 's/-march=armv8-a+fp+simd/-march=x86-64/g' $RACK_DIR/arch.mk 2>/dev/null || true
            sed -i.bak 's/-march=armv8-a+fp+simd/-march=x86-64/g' $RACK_DIR/plugin.mk 2>/dev/null || true
            export CXXFLAGS="-arch x86_64"
            export LDFLAGS="-arch x86_64"
          fi
          make -j$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)

      - name: Create distribution
        run: |
          export RACK_DIR=$PWD/Rack-SDK
          if [ "${{ matrix.platform }}" = "mac-x64" ]; then
            export CXXFLAGS="-arch x86_64"
            export LDFLAGS="-arch x86_64"
          fi
          export ARCH=${{ matrix.platform }}
          make dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-${{ matrix.platform }}
          path: dist/*.vcvplugin

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: plugin-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.vcvplugin
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
