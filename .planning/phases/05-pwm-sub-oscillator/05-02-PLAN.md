---
phase: 05-pwm-sub-oscillator
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/HydraQuartetVCO.cpp
  - res/HydraQuartetVCO.svg
autonomous: false

must_haves:
  truths:
    - "User can hear sub-oscillator one octave below VCO1"
    - "User can switch sub-oscillator between square and sine waveforms"
    - "User can mix sub-oscillator into main output with level control"
    - "User can get sub-oscillator from dedicated SUB output"
  artifacts:
    - path: "src/HydraQuartetVCO.cpp"
      provides: "Sub-oscillator generation and mixing"
      contains: "subPhase"
    - path: "src/HydraQuartetVCO.cpp"
      provides: "Sub waveform switch"
      contains: "SUB_WAVE_PARAM"
    - path: "src/HydraQuartetVCO.cpp"
      provides: "Sub dedicated output"
      contains: "SUB_OUTPUT"
  key_links:
    - from: "basePitch"
      to: "subFreq"
      via: "pitch calculation with -1 octave offset"
      pattern: "basePitch.*octave1.*- 1\\.f"
    - from: "subOut"
      to: "mixed output"
      via: "level-controlled addition"
      pattern: "subOut.*subLevel"
    - from: "subOut"
      to: "SUB_OUTPUT"
      via: "setVoltageSimd"
      pattern: "outputs\\[SUB_OUTPUT\\].*setVoltageSimd"
---

<objective>
Implement sub-oscillator tracking VCO1 at -1 octave with switchable square/sine waveform, level control, and dedicated output.

Purpose: Sub-oscillator provides bass reinforcement and timbral foundation. Having both mixed output (internal routing) and dedicated output (external processing) gives maximum flexibility.

Output: Working sub-oscillator with waveform switch, level knob, and dedicated output jack.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-pwm-sub-oscillator/05-CONTEXT.md
@.planning/phases/05-pwm-sub-oscillator/05-RESEARCH.md
@.planning/phases/05-pwm-sub-oscillator/05-01-SUMMARY.md
@src/HydraQuartetVCO.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sub-oscillator params, output, and DSP</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
Implement sub-oscillator at -1 octave below VCO1 base pitch:

1. Add to ParamId enum (in VCO1 section, after PWM1_ATT_PARAM):
   - SUB_WAVE_PARAM   (square/sine switch)
   - SUB_LEVEL_PARAM  (mix level)

2. Add to OutputId enum:
   - SUB_OUTPUT

3. Add member variables in HydraQuartetVCO class (after vco2):
```cpp
// Sub-oscillator state (tracks VCO1 at -1 octave)
float_4 subPhase[4] = {};
```

4. In constructor, configure sub-oscillator params:
```cpp
// Sub-oscillator parameters (in VCO1 section)
configSwitch(SUB_WAVE_PARAM, 0.f, 1.f, 0.f, "Sub Waveform", {"Square", "Sine"});
configParam(SUB_LEVEL_PARAM, 0.f, 1.f, 0.f, "Sub Level", "%", 0.f, 100.f);

// Outputs
configOutput(SUB_OUTPUT, "Sub-Oscillator");
```

5. In process(), read sub params before SIMD loop:
```cpp
float subWave = params[SUB_WAVE_PARAM].getValue();  // 0 = square, 1 = sine
float subLevel = params[SUB_LEVEL_PARAM].getValue();
```

6. Inside SIMD loop, after frequency calculations for VCO1/VCO2, add sub-oscillator:
```cpp
// Sub-oscillator: -1 octave below VCO1 base (ignores detune for stable foundation)
float_4 subPitch = basePitch + octave1 - 1.f;  // VCO1 base pitch minus 1 octave
float_4 subFreq = dsp::FREQ_C4 * dsp::exp2_taylor5(subPitch);
subFreq = simd::clamp(subFreq, 0.1f, sampleRate / 2.f);

// Sub phase accumulation
float_4 subDelta = subFreq * sampleTime;
subPhase[g] += subDelta;
subPhase[g] -= simd::floor(subPhase[g]);

// Generate both waveforms
float_4 subSquare = simd::ifelse(subPhase[g] < 0.5f, 1.f, -1.f);
float_4 subSine = simd::sin(2.f * float(M_PI) * subPhase[g]);

// Select based on switch
float_4 subOut = (subWave < 0.5f) ? subSquare : subSine;

// Output to dedicated SUB jack (full level, before mixing)
outputs[SUB_OUTPUT].setVoltageSimd(subOut * 5.f, c);
```

7. Modify the VCO mixing line to include sub-oscillator:
```cpp
// Mix both VCOs with independent volume controls, plus sub-oscillator
float_4 mixed = tri1 * triVol1 + sqr1 * sqrVol1 + sine1 * sinVol1 + saw1 * sawVol1
              + tri2 * triVol2 + sqr2 * sqrVol2 + sine2 * sinVol2 + saw2 * sawVol2
              + subOut * subLevel;
```

8. After the SIMD loop (before mix output), set SUB_OUTPUT channel count:
```cpp
outputs[SUB_OUTPUT].setChannels(channels);
```

Note: Sub ignores VCO1 detune (`basePitch + octave1 - 1.f` not `pitch1 - 1.f`) per context decision for stable foundation.
  </action>
  <verify>
Run `make` in plugin directory. Compilation succeeds with no errors.
  </verify>
  <done>
SUB_WAVE_PARAM, SUB_LEVEL_PARAM, SUB_OUTPUT exist. Sub-oscillator generates square or sine at -1 octave below VCO1 base pitch (ignoring detune). Output goes to both dedicated jack and main mix.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add sub-oscillator UI controls to widget</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
Add sub-oscillator controls in VCO1 section:

1. In HydraQuartetVCOWidget constructor, add sub-oscillator controls.
   Position near VCO1 section (left side). Find space below or beside existing VCO1 controls.

   Suggested positions (adjust if overlapping with existing components):
```cpp
// Sub-oscillator controls (VCO1 section, near bottom)
// Sub waveform switch (toggle between square and sine)
addParam(createParamCentered<CKSS>(mm2px(Vec(25.4, 88.0)), module, HydraQuartetVCO::SUB_WAVE_PARAM));

// Sub level knob
addParam(createParamCentered<RoundBlackKnob>(mm2px(Vec(10.16, 88.0)), module, HydraQuartetVCO::SUB_LEVEL_PARAM));

// Sub output jack
addOutput(createOutputCentered<PJ301MPort>(mm2px(Vec(40.64, 88.0)), module, HydraQuartetVCO::SUB_OUTPUT));
```

Note: CKSS is the standard VCV toggle switch. RoundBlackKnob matches existing controls. PJ301MPort is standard output jack.
  </action>
  <verify>
Run `make` in plugin directory. Then load module in VCV Rack and verify:
1. Sub waveform toggle switch appears in VCO1 section
2. Sub level knob appears in VCO1 section
3. SUB output jack appears in VCO1 section
4. No component overlap with existing controls
  </verify>
  <done>
Widget displays sub-oscillator controls: CKSS waveform switch, RoundBlackKnob level control, PJ301MPort output jack in VCO1 section.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify sub-oscillator functionality</name>
  <what-built>
Sub-oscillator implementation:
- Square/Sine waveform switch
- Level control mixing into main output
- Dedicated SUB output jack
- Tracking VCO1 at exactly -1 octave
  </what-built>
  <how-to-verify>
1. Load HydraQuartetVCO in VCV Rack
2. Connect AUDIO_OUTPUT to a mixer/scope
3. Connect SUB_OUTPUT to a separate mixer channel or second scope

Test sub-oscillator pitch tracking:
4. Play a note via V/Oct (e.g., from MIDI-CV)
5. Listen to main output (VCO1 + VCO2)
6. Turn up SUB_LEVEL knob
7. Confirm sub-oscillator is one octave below VCO1 fundamental
8. Change VCO1 octave switch - verify sub follows VCO1 base pitch

Test waveform switch:
9. Toggle SUB_WAVE_PARAM switch
10. Confirm switch changes between square (buzzy) and sine (smooth) sub tone

Test detune isolation:
11. Turn VCO1 DETUNE knob up
12. Confirm sub-oscillator does NOT beat against VCO2 (sub ignores detune)

Test dedicated output:
13. Verify SUB_OUTPUT produces the sub-oscillator signal
14. Verify SUB_OUTPUT is polyphonic (matches V/Oct channels)

Listen for:
- No aliasing on square sub at high VCO1 pitches (may need sine at extreme highs)
- Sub reinforces bass without phase cancellation
- Clean mix when sub is blended with main VCOs
  </how-to-verify>
  <resume-signal>Type "approved" if sub-oscillator works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. `make` succeeds with no warnings related to sub-oscillator
2. Module loads in VCV Rack without crashes
3. Sub-oscillator tracks VCO1 pitch at exactly -1 octave
4. Sub-oscillator ignores VCO1 detune (stable foundation)
5. Waveform switch toggles between square and sine
6. Level knob controls sub in main mix
7. SUB_OUTPUT provides dedicated polyphonic sub output
8. No aliasing artifacts on square sub
</verification>

<success_criteria>
- User can hear sub-oscillator one octave below VCO1 fundamental
- Developer can verify sub-oscillator tracks VCO1 pitch exactly (-1 octave)
- User can switch sub between square (buzzy) and sine (smooth) character
- User can control sub level in main mix independently
- User can route sub-oscillator externally via dedicated output
</success_criteria>

<output>
After completion, create `.planning/phases/05-pwm-sub-oscillator/05-02-SUMMARY.md`
</output>
