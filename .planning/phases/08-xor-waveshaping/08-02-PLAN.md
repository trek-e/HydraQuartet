---
phase: 08-xor-waveshaping
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/HydraQuartetVCO.cpp
autonomous: true

must_haves:
  truths:
    - "User can patch CV to control waveform volumes polyphonically"
    - "CV input replaces knob value when patched (not additive)"
    - "0-10V CV maps directly to 0-10 volume"
  artifacts:
    - path: "src/HydraQuartetVCO.cpp"
      provides: "6 polyphonic CV inputs for waveform volumes"
      contains: "SAW1_CV_INPUT"
  key_links:
    - from: "process() loop"
      to: "getPolyVoltageSimd"
      via: "Reading CV for each waveform"
      pattern: "getPolyVoltageSimd.*CV"
    - from: "CV connected check"
      to: "volume calculation"
      via: "CV replaces knob pattern"
      pattern: "isConnected.*clamp|clamp.*isConnected"
---

<objective>
Add 6 polyphonic CV inputs for waveform volume control (SAW1, SQR1, SUB, XOR, SQR2, SAW2).

Purpose: Enables per-voice volume automation and modulation of selected waveforms, supporting polyphonic patches where each voice has independent volume control.

Output: 6 new CV inputs with CV-replaces-knob behavior and 0-10V to 0-10 volume mapping.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-xor-waveshaping/08-CONTEXT.md
@.planning/phases/08-xor-waveshaping/08-RESEARCH.md
@src/HydraQuartetVCO.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CV input enums and configure inputs</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
Add 6 new CV inputs to the InputId enum (before INPUTS_LEN):
```cpp
enum InputId {
    // Global
    VOCT_INPUT,
    GATE_INPUT,
    // VCO1
    PWM1_INPUT,
    // VCO2
    PWM2_INPUT,
    FM_INPUT,
    // Waveform volume CV inputs (NEW)
    SAW1_CV_INPUT,
    SQR1_CV_INPUT,
    SUB_CV_INPUT,
    XOR_CV_INPUT,
    SQR2_CV_INPUT,
    SAW2_CV_INPUT,
    INPUTS_LEN
};
```

In the constructor, configure the new inputs:
```cpp
// Waveform volume CV inputs
configInput(SAW1_CV_INPUT, "SAW1 Volume CV");
configInput(SQR1_CV_INPUT, "SQR1 Volume CV");
configInput(SUB_CV_INPUT, "Sub Volume CV");
configInput(XOR_CV_INPUT, "XOR Volume CV");
configInput(SQR2_CV_INPUT, "SQR2 Volume CV");
configInput(SAW2_CV_INPUT, "SAW2 Volume CV");
```
  </action>
  <verify>Code compiles: `cd /Users/trekkie/projects/vcvrack_modules/vco && make`</verify>
  <done>6 CV inputs defined in enum and configured in constructor</done>
</task>

<task type="auto">
  <name>Task 2: Implement CV-replaces-knob volume control</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
In the process() function, before the SIMD loop, check which CV inputs are connected:
```cpp
// Read waveform volume knobs (existing)
float saw1Knob = params[SAW1_PARAM].getValue();
float sqr1Knob = params[SQR1_PARAM].getValue();
float subKnob = params[SUB_LEVEL_PARAM].getValue();
// Note: XOR knob will be added in Plan 03
float sqr2Knob = params[SQR2_PARAM].getValue();
float saw2Knob = params[SAW2_PARAM].getValue();

// Check CV connections (outside loop for efficiency)
bool saw1CVConnected = inputs[SAW1_CV_INPUT].isConnected();
bool sqr1CVConnected = inputs[SQR1_CV_INPUT].isConnected();
bool subCVConnected = inputs[SUB_CV_INPUT].isConnected();
bool xorCVConnected = inputs[XOR_CV_INPUT].isConnected();
bool sqr2CVConnected = inputs[SQR2_CV_INPUT].isConnected();
bool saw2CVConnected = inputs[SAW2_CV_INPUT].isConnected();
```

Inside the SIMD loop, read polyphonic CV and apply CV-replaces-knob pattern:
```cpp
for (int c = 0; c < channels; c += 4) {
    int g = c / 4;

    // ... existing pitch/freq/pwm code ...

    // Read waveform volume CVs (polyphonic)
    float_4 saw1CV = inputs[SAW1_CV_INPUT].getPolyVoltageSimd<float_4>(c);
    float_4 sqr1CV = inputs[SQR1_CV_INPUT].getPolyVoltageSimd<float_4>(c);
    float_4 subCV = inputs[SUB_CV_INPUT].getPolyVoltageSimd<float_4>(c);
    float_4 xorCV = inputs[XOR_CV_INPUT].getPolyVoltageSimd<float_4>(c);
    float_4 sqr2CV = inputs[SQR2_CV_INPUT].getPolyVoltageSimd<float_4>(c);
    float_4 saw2CV = inputs[SAW2_CV_INPUT].getPolyVoltageSimd<float_4>(c);

    // CV replaces knob when patched, 0-10V maps to 0-10 volume
    float_4 saw1Vol_4 = saw1CVConnected ? simd::clamp(saw1CV, 0.f, 10.f) : float_4(saw1Knob);
    float_4 sqr1Vol_4 = sqr1CVConnected ? simd::clamp(sqr1CV, 0.f, 10.f) : float_4(sqr1Knob);
    float_4 subVol_4 = subCVConnected ? simd::clamp(subCV, 0.f, 10.f) : float_4(subKnob);
    float_4 xorVol_4 = xorCVConnected ? simd::clamp(xorCV, 0.f, 10.f) : float_4(0.f); // XOR default 0 until knob added
    float_4 sqr2Vol_4 = sqr2CVConnected ? simd::clamp(sqr2CV, 0.f, 10.f) : float_4(sqr2Knob);
    float_4 saw2Vol_4 = saw2CVConnected ? simd::clamp(saw2CV, 0.f, 10.f) : float_4(saw2Knob);

    // ... existing waveform generation ...
}
```

Update the mix calculation to use the new float_4 volume variables:
```cpp
// Mix both VCOs with CV-controlled volumes
// Note: tri and sine still use scalar knob values (no CV per Context decision)
float_4 mixed = (tri1 * triVol1 + sqr1 * sqr1Vol_4 + sine1 * sinVol1 + saw1 * saw1Vol_4
              + tri2 * triVol2 + sqr2 * sqr2Vol_4 + sine2 * sinVol2 + saw2 * saw2Vol_4
              + subOut * subVol_4
              // XOR will be added in Plan 03 after it's wired
              ) * outputScale;
```
  </action>
  <verify>
1. Code compiles: `make`
2. Test in VCV Rack: patch 0V to SAW1_CV - volume should be 0
3. Patch 10V to SAW1_CV - volume should be maximum
4. Patch polyphonic signal - each voice should respond independently
  </verify>
  <done>CV inputs read polyphonically, CV replaces knob when patched, 0-10V maps to 0-10 volume</done>
</task>

</tasks>

<verification>
1. Code compiles without errors
2. All 6 CV inputs configured and accessible
3. CV replaces knob behavior:
   - No CV patched: knob value used
   - CV patched: CV value used (knob ignored)
4. Voltage mapping: 0V = silent, 10V = full volume
5. Polyphonic CV: each voice responds to its corresponding CV channel
</verification>

<success_criteria>
- 6 CV inputs added to InputId enum: SAW1_CV, SQR1_CV, SUB_CV, XOR_CV, SQR2_CV, SAW2_CV
- All inputs configured in constructor
- CV-replaces-knob pattern implemented (not additive)
- 0-10V direct mapping to 0-10 volume
- Polyphonic CV via getPolyVoltageSimd()
- Code compiles and module loads in VCV Rack
</success_criteria>

<output>
After completion, create `.planning/phases/08-xor-waveshaping/08-02-SUMMARY.md`
</output>
