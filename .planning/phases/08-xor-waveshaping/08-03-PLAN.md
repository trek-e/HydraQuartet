---
phase: 08-xor-waveshaping
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/HydraQuartetVCO.cpp
  - res/HydraQuartetVCO.svg
autonomous: false

must_haves:
  truths:
    - "User can see XOR volume knob on VCO2 section"
    - "User can hear XOR output mixed with VCO2 waveforms"
    - "User can see 6 CV jacks below corresponding volume knobs"
    - "Soft clipping prevents harsh digital distortion when many waveforms active"
  artifacts:
    - path: "src/HydraQuartetVCO.cpp"
      provides: "XOR param, UI wiring, soft clipping"
      contains: "XOR_PARAM"
    - path: "res/HydraQuartetVCO.svg"
      provides: "40HP panel with XOR knob and 6 CV jacks"
  key_links:
    - from: "XOR calculation"
      to: "mixed output"
      via: "xor * xorVol addition"
      pattern: "xor.*xorVol|xorVol.*xor"
    - from: "DC filter output"
      to: "soft clipping"
      via: "tanh saturation"
      pattern: "tanh"
---

<objective>
Complete XOR integration with UI controls, panel updates to 40HP, and add soft clipping to output.

Purpose: Makes XOR output accessible to users with volume control, adds CV jacks to panel, and ensures output headroom is managed gracefully.

Output: Complete XOR waveform accessible via VCO2 mix, 40HP panel with all new controls, soft clipping on output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-xor-waveshaping/08-CONTEXT.md
@.planning/phases/08-xor-waveshaping/08-RESEARCH.md
@.planning/phases/08-xor-waveshaping/08-01-SUMMARY.md
@.planning/phases/08-xor-waveshaping/08-02-SUMMARY.md
@src/HydraQuartetVCO.cpp
@res/HydraQuartetVCO.svg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add XOR parameter and wire to mix</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
Add XOR_PARAM to ParamId enum (in VCO2 section):
```cpp
enum ParamId {
    // ... existing VCO1 params ...
    // VCO2 Section
    OCTAVE2_PARAM,
    FINE2_PARAM,
    TRI2_PARAM,
    SQR2_PARAM,
    SIN2_PARAM,
    SAW2_PARAM,
    XOR_PARAM,  // NEW: XOR volume control
    PWM2_PARAM,
    PWM2_ATT_PARAM,
    SYNC2_PARAM,
    FM_PARAM,
    FM_ATT_PARAM,
    PARAMS_LEN
};
```

Configure the XOR parameter in constructor (default to 0 - off):
```cpp
configParam(XOR_PARAM, 0.f, 10.f, 0.f, "XOR Volume");
```

In process(), read the XOR knob:
```cpp
float xorKnob = params[XOR_PARAM].getValue();
```

Update the xorVol_4 calculation (from Plan 02) to use the knob:
```cpp
float_4 xorVol_4 = xorCVConnected ? simd::clamp(xorCV, 0.f, 10.f) : float_4(xorKnob);
```

Wire the XOR output into the mix:
```cpp
// Calculate XOR from sqr1 * sqr2 (from Plan 01)
float_4 xorOut = sqr1 * sqr2;
xorOut += vco2.xorMinBlepBuffer[g].process();  // VCO2 edges
xorOut += xorFromVco1MinBlep[g].process();      // VCO1 edges

// Mix with all waveforms including XOR
float_4 mixed = (tri1 * triVol1 + sqr1 * sqr1Vol_4 + sine1 * sinVol1 + saw1 * saw1Vol_4
              + tri2 * triVol2 + sqr2 * sqr2Vol_4 + sine2 * sinVol2 + saw2 * saw2Vol_4
              + subOut * subVol_4
              + xorOut * xorVol_4) * outputScale;
```
  </action>
  <verify>Code compiles: `make`</verify>
  <done>XOR parameter defined, configured, and wired into mix output</done>
</task>

<task type="auto">
  <name>Task 2: Add soft clipping to output</name>
  <files>src/HydraQuartetVCO.cpp</files>
  <action>
After DC filtering, apply soft clipping using tanh() before output:
```cpp
// DC filtering - process per-voice
for (int i = 0; i < groupChannels; i++) {
    dcFilters[c + i].setCutoffFreq(10.f / sampleRate);
    dcFilters[c + i].process(mixed[i]);
    float dcFiltered = dcFilters[c + i].highpass();

    // Soft clipping with tanh
    // Scale factor 3.0: saturates at approximately ±3V input
    // This prevents harsh digital clipping when many waveforms sum
    float softClipped = 3.f * std::tanh(dcFiltered / 3.f);

    // Apply output scaling (±2V for testing, ±5V for production)
    float out = softClipped * 2.f;

    // Sanitize output: replace NaN/Inf with 0
    mixed[i] = std::isfinite(out) ? out : 0.f;

    // Per-voice outputs
    int voiceIdx = c + i;
    if (voiceIdx < 8) {
        outputs[VOICE1_OUTPUT + voiceIdx].setVoltage(mixed[i]);
    }
}
```

Note: std::tanh() is in <cmath> which is already included.
  </action>
  <verify>
1. Code compiles: `make`
2. In VCV Rack, turn all waveform volumes to max
3. Output should saturate smoothly, not clip harshly
  </verify>
  <done>Soft clipping via tanh() applied to output, preventing harsh digital clipping</done>
</task>

<task type="auto">
  <name>Task 3: Update panel to 40HP and add UI components</name>
  <files>res/HydraQuartetVCO.svg, src/HydraQuartetVCO.cpp</files>
  <action>
**Panel SVG updates (res/HydraQuartetVCO.svg):**

1. Expand panel width from 36HP (182.88mm) to 40HP (203.2mm):
   - Update viewBox and width attribute
   - Extend background rectangle

2. Add XOR label and knob position in VCO2 waveform section:
   - Position between SAW2 and PWM2 row, or in a logical place in the waveform row
   - Label: "XOR" text element

3. Add 6 CV jack positions below corresponding volume knobs:
   - VCO1 side: SAW1-CV, SQR1-CV, SUB-CV
   - VCO2 side: XOR-CV, SQR2-CV, SAW2-CV
   - Minimum 13mm spacing between jacks
   - Add labels: "CV" text below each jack position

**Widget C++ updates (src/HydraQuartetVCO.cpp):**

Update HydraQuartetVCOWidget to add new components:

```cpp
// XOR volume knob (VCO2 section - position based on SVG layout)
// Example position, adjust based on actual SVG:
addParam(createParamCentered<RoundBlackKnob>(mm2px(Vec(187.96, 48.0)), module, HydraQuartetVCO::XOR_PARAM));

// CV input jacks (positions below corresponding volume knobs)
// VCO1 side
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(55.88, 58.0)), module, HydraQuartetVCO::SAW1_CV_INPUT));
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(25.4, 58.0)), module, HydraQuartetVCO::SQR1_CV_INPUT));
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(10.16, 98.0)), module, HydraQuartetVCO::SUB_CV_INPUT));

// VCO2 side (adjust X positions for 40HP layout)
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(187.96, 58.0)), module, HydraQuartetVCO::XOR_CV_INPUT));
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(142.24, 58.0)), module, HydraQuartetVCO::SQR2_CV_INPUT));
addInput(createInputCentered<PJ301MPort>(mm2px(Vec(172.72, 58.0)), module, HydraQuartetVCO::SAW2_CV_INPUT));
```

Positions are approximate - adjust based on actual SVG layout to ensure:
- CV jacks are directly below their corresponding knobs
- No component overlap
- VCV Rack spacing guidelines followed (10mm minimum between centers)
  </action>
  <verify>
1. Code compiles: `make`
2. Open VCV Rack, verify panel is 40HP
3. Verify XOR knob visible and functional
4. Verify all 6 CV jacks visible and functional
  </verify>
  <done>Panel expanded to 40HP with XOR knob and 6 CV jacks positioned correctly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete XOR waveshaping feature:
- XOR ring modulation output (sqr1 * sqr2) with MinBLEP antialiasing
- XOR volume knob in VCO2 section (default off)
- 6 polyphonic CV inputs for waveform volumes
- Soft clipping on output (tanh saturation)
- 40HP panel with all new controls
  </what-built>
  <how-to-verify>
1. Open VCV Rack with HydraQuartetVCO module
2. Connect V/Oct from a MIDI-CV module
3. Connect AUDIO output to a scope (Bogaudio ANALYZER-XL or similar)

**Test XOR output:**
4. Set SQR1 and SQR2 to 5, all other waveforms to 0
5. Turn XOR knob from 0 to 5
6. Verify XOR waveform visible on scope (ring modulation of two squares)
7. Detune VCO1 slightly - XOR should create beating/ring mod effect
8. Adjust PWM1 and PWM2 - verify XOR character changes

**Test CV inputs:**
9. Patch a slow LFO (0-10V unipolar) to SAW1-CV
10. Turn SAW1 knob to any position - LFO should control volume
11. Verify other CV inputs work similarly

**Test soft clipping:**
12. Set all VCO1 waveforms to 10, all VCO2 waveforms to 10, XOR to 10
13. Output should be saturated but smooth, not harsh digital clipping

**Visual inspection:**
14. Panel is 40HP wide
15. XOR knob visible in VCO2 section
16. 6 CV jacks visible below corresponding volume knobs
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. XOR_PARAM defined and configured (default 0)
2. XOR wired into mix with volume control
3. Soft clipping via tanh() on output
4. Panel SVG updated to 40HP
5. XOR knob added to widget
6. 6 CV jacks added to widget
7. Human verified: XOR sounds correct, CV inputs work, soft clipping effective
</verification>

<success_criteria>
- XOR output audible when XOR knob > 0
- XOR responds to PWM changes on both VCOs
- CV inputs replace knob values when patched
- Soft clipping prevents harsh distortion with all waveforms active
- Panel is 40HP with all new controls visible and functional
- Human approval received
</success_criteria>

<output>
After completion, create `.planning/phases/08-xor-waveshaping/08-03-SUMMARY.md`
</output>
